#!/usr/bin/env python3
"""
Keyboard Teleop Node for Tank Drive Rover.

Controls the rover using keyboard input: 
- W/S:  Forward/Backward
- A/D: Turn Left/Right
- Q/E: Rotate in place Left/Right
- Space: Stop
- Shift: Boost speed

This node publishes Twist messages to /vex/cmd_vel. 

Author: Rover Team
"""

import sys
import termios
import tty
import select
import rclpy
from rclpy. node import Node
from geometry_msgs.msg import Twist


# Key bindings
MOVE_BINDINGS = {
    'w':  (1. 0, 0.0),   # Forward
    's': (-1.0, 0.0),  # Backward
    'a': (0.0, 1.0),   # Turn left (forward + rotate)
    'd': (0.0, -1.0),  # Turn right (forward + rotate)
    'q': (0.0, 1.0),   # Rotate left in place
    'e': (0.0, -1.0),  # Rotate right in place
    ' ': (0.0, 0.0),   # Stop
}

# Arrow keys (escape sequences)
ARROW_BINDINGS = {
    '\x1b[A': (1.0, 0.0),   # Up arrow - forward
    '\x1b[B': (-1.0, 0.0),  # Down arrow - backward
    '\x1b[C':  (0.0, -1.0),  # Right arrow - turn right
    '\x1b[D': (0.0, 1.0),   # Left arrow - turn left
}


HELP_MSG = """
╔════════════════════════════════════════════════════════╗
║           LUNAR ROVER KEYBOARD TELEOP                  ║
╠════════════════════════════��═══════════════════════════╣
║                                                        ║
║   Movement Controls:                                   ║
║   ┌───────────────────────────────────┐                ║
║   │         W / ↑                     │                ║
║   │         Forward                   │                ║
║   │                                   │                ║
║   │   A / ←     S / ↓     D / →       │                ║
║   │   Left      Back      Right       │                ║
║   │                                   │                ║
║   │   Q         Space     E           │                ║
║   │   Spin L    STOP      Spin R      │                ║
║   └───────────────────────────────────┘                ║
║                                                        ║
║   Speed Controls:                                      ║
║   ┌───────────────────────────────────┐                ║
║   │   + / =    Increase speed         │                ║
║   │   - / _    Decrease speed         │                ║
║   │   Shift    Hold for boost         │                ║
║   └─���─────────────────────────────────┘                ║
║                                                        ║
║   Ctrl+C to quit                                       ║
║                                                        ║
╚════════════════════════════════════════════════════════╝
"""


class KeyboardTeleopNode(Node):
    """Keyboard teleop node for tank drive rover."""
    
    def __init__(self):
        super().__init__('keyboard_teleop_node')
        
        # Parameters
        self.declare_parameter('linear_speed', 0.2)
        self.declare_parameter('angular_speed', 1.0)
        self.declare_parameter('linear_speed_max', 0.5)
        self.declare_parameter('angular_speed_max', 2.0)
        self.declare_parameter('speed_increment', 0.05)
        self.declare_parameter('boost_multiplier', 1.5)
        self.declare_parameter('publish_rate', 10.0)
        self.declare_parameter('cmd_vel_topic', '/vex/cmd_vel')
        
        self.linear_speed = self.get_parameter('linear_speed').value
        self.angular_speed = self.get_parameter('angular_speed').value
        self.linear_max = self.get_parameter('linear_speed_max').value
        self.angular_max = self. get_parameter('angular_speed_max').value
        self.speed_increment = self.get_parameter('speed_increment').value
        self.boost_multiplier = self.get_parameter('boost_multiplier').value
        
        cmd_vel_topic = self.get_parameter('cmd_vel_topic').value
        
        # Publisher
        self.cmd_pub = self.create_publisher(Twist, cmd_vel_topic, 10)
        
        # Current velocity
        self.current_linear = 0.0
        self. current_angular = 0.0
        
        # Terminal settings
        self.settings = termios.tcgetattr(sys.stdin)
        
        self.get_logger().info('Keyboard Teleop started')
        print(HELP_MSG)
        self._print_speed()
    
    def _print_speed(self):
        """Print current speed settings."""
        print(f'\rSpeed: linear={self.linear_speed:.2f} m/s, angular={self. angular_speed:.2f} rad/s    ', end='')
        sys.stdout.flush()
    
    def _get_key(self):
        """Get a single keypress from terminal."""
        tty.setraw(sys.stdin.fileno())
        rlist, _, _ = select.select([sys.stdin], [], [], 0.1)
        
        if rlist:
            key = sys.stdin.read(1)
            
            # Check for escape sequence (arrow keys)
            if key == '\x1b': 
                additional = sys.stdin.read(2)
                key = key + additional
            
            return key
        
        return None
    
    def run(self):
        """Main teleop loop."""
        try:
            while rclpy.ok():
                key = self._get_key()
                
                linear = 0.0
                angular = 0.0
                boost = 1.0
                
                if key is not None:
                    key_lower = key.lower() if len(key) == 1 else key
                    
                    # Check for quit
                    if key == '\x03':  # Ctrl+C
                        break
                    
                    # Check for movement keys
                    if key_lower in MOVE_BINDINGS: 
                        linear, angular = MOVE_BINDINGS[key_lower]
                    elif key in ARROW_BINDINGS: 
                        linear, angular = ARROW_BINDINGS[key]
                    
                    # Speed adjustments
                    elif key in ['+', '=']:
                        self.linear_speed = min(self.linear_max, 
                                               self.linear_speed + self. speed_increment)
                        self.angular_speed = min(self.angular_max,
                                                self.angular_speed + self.speed_increment * 2)
                        self._print_speed()
                    elif key in ['-', '_']:
                        self.linear_speed = max(0.05, 
                                               self.linear_speed - self.speed_increment)
                        self.angular_speed = max(0.1,
                                                self.angular_speed - self.speed_increment * 2)
                        self._print_speed()
                    
                    # Boost with shift (uppercase letters)
                    if key.isupper() and len(key) == 1:
                        boost = self.boost_multiplier
                
                # Apply speed scaling
                linear_vel = linear * self.linear_speed * boost
                angular_vel = angular * self.angular_speed * boost
                
                # Create and publish Twist message
                twist = Twist()
                twist. linear.x = linear_vel
                twist.angular.z = angular_vel
                self.cmd_pub.publish(twist)
                
                # Process ROS callbacks
                rclpy.spin_once(self, timeout_sec=0)
                
        finally:
            # Restore terminal
            termios.tcsetattr(sys.stdin, termios. TCSADRAIN, self.settings)
            
            # Send stop command
            twist = Twist()
            self.cmd_pub.publish(twist)
            
            print('\nTeleop stopped.')


def main(args=None):
    rclpy.init(args=args)
    
    node = KeyboardTeleopNode()
    
    try:
        node.run()
    except KeyboardInterrupt:
        pass
    finally:
        node. destroy_node()
        rclpy.shutdown()


if __name__ == '__main__':
    main()