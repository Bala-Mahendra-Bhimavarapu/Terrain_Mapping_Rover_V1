"""
FULL SYSTEM LAUNCH - Everything for Complete Autonomous Operation

This launch file starts ALL components needed for full autonomous operation. 

MODES:
1. FULL SLAM + NAV2 (default): Complete SLAM and navigation stack
2. BEACON HOMING: Autonomous navigation to Bluetooth beacon (no SLAM needed)
3. HYBRID:  SLAM + Nav2 + Beacon homing available

Usage:
    # Full system with SLAM + Nav2
    ros2 launch rover_bringup full_system.launch.py
    
    # Beacon homing only (minimal, no SLAM)
    ros2 launch rover_bringup full_system.launch.py mode:=beacon_homing
    
    # Full system with beacon homing available
    ros2 launch rover_bringup full_system.launch.py enable_beacon_homing:=true

Author:  Rover Team
"""

from launch import LaunchDescription
from launch. actions import (
    DeclareLaunchArgument,
    IncludeLaunchDescription,
    GroupAction,
    TimerAction,
    LogInfo,
    OpaqueFunction
)
from launch.conditions import IfCondition, UnlessCondition, LaunchConfigurationEquals
from launch. substitutions import (
    LaunchConfiguration, 
    PythonExpression,
    AndSubstitution,
    OrSubstitution,
    NotSubstitution
)
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch_ros.actions import Node, SetParameter
from ament_index_python.packages import get_package_share_directory
import os


def generate_launch_description():
    # =========================================================================
    # PACKAGE DIRECTORIES
    # =========================================================================
    pkg_bringup = get_package_share_directory('rover_bringup')
    pkg_description = get_package_share_directory('rover_description')
    pkg_vex = get_package_share_directory('vex_serial')
    pkg_imu = get_package_share_directory('imu_driver')
    pkg_camera = get_package_share_directory('imx500_camera')
    pkg_tof = get_package_share_directory('arducam_tof')
    pkg_fusion = get_package_share_directory('sensor_fusion')
    pkg_auto_exp = get_package_share_directory('auto_exposure')
    pkg_health = get_package_share_directory('mission_health')
    pkg_waypoint = get_package_share_directory('waypoint_manager')
    pkg_landmark = get_package_share_directory('landmark_system')
    pkg_streaming = get_package_share_directory('rover_streaming')
    pkg_bluetooth = get_package_share_directory('bluetooth_nav')
    pkg_beacon_homing = get_package_share_directory('beacon_homing')
    pkg_dashboard = get_package_share_directory('web_dashboard')
    
    # =========================================================================
    # CONFIGURATION FILES
    # =========================================================================
    vex_config = os.path. join(pkg_vex, 'config', 'vex_serial_params.yaml')
    imu_config = os.path.join(pkg_imu, 'config', 'mpu6050_params.yaml')
    camera_config = os.path.join(pkg_camera, 'config', 'imx500_params.yaml')
    tof_config = os.path.join(pkg_tof, 'config', 'arducam_tof_params.yaml')
    ekf_config = os.path. join(pkg_fusion, 'config', 'ekf_params.yaml')
    auto_exp_config = os.path.join(pkg_auto_exp, 'config', 'auto_exposure_params.yaml')
    health_config = os.path.join(pkg_health, 'config', 'mission_health_params.yaml')
    waypoint_config = os.path.join(pkg_waypoint, 'config', 'waypoint_params.yaml')
    landmark_config = os.path.join(pkg_landmark, 'config', 'landmark_params.yaml')
    streaming_config = os.path.join(pkg_streaming, 'config', 'streaming_params.yaml')
    bluetooth_config = os.path.join(pkg_bluetooth, 'config', 'bluetooth_params.yaml')
    beacon_homing_config = os.path.join(pkg_beacon_homing, 'config', 'beacon_homing_params.yaml')
    rtabmap_config = os.path.join(pkg_bringup, 'config', 'rtabmap_params.yaml')
    nav2_config = os.path. join(pkg_bringup, 'config', 'nav2_params.yaml')
    
    # =========================================================================
    # LAUNCH ARGUMENTS
    # =========================================================================
    declared_arguments = [
        # === MODE SELECTION ===
        DeclareLaunchArgument(
            'mode',
            default_value='full',
            description='Launch mode: full, beacon_homing, minimal'
        ),
        
        # === SIMULATION / HARDWARE MODE ===
        DeclareLaunchArgument(
            'use_mock',
            default_value='false',
            description='Use mock sensor nodes (for testing without hardware)'
        ),
        DeclareLaunchArgument(
            'use_sim_time',
            default_value='false',
            description='Use simulation time'
        ),
        
        # === FEATURE TOGGLES ===
        DeclareLaunchArgument(
            'enable_slam',
            default_value='true',
            description='Enable RTAB-Map SLAM'
        ),
        DeclareLaunchArgument(
            'enable_nav2',
            default_value='true',
            description='Enable Nav2 navigation stack'
        ),
        DeclareLaunchArgument(
            'enable_camera',
            default_value='true',
            description='Enable RGB camera'
        ),
        DeclareLaunchArgument(
            'enable_auto_exposure',
            default_value='true',
            description='Enable auto-exposure controller'
        ),
        DeclareLaunchArgument(
            'enable_landmarks',
            default_value='true',
            description='Enable YOLO landmark detection'
        ),
        DeclareLaunchArgument(
            'enable_waypoints',
            default_value='true',
            description='Enable waypoint recording and following'
        ),
        DeclareLaunchArgument(
            'enable_health_monitor',
            default_value='true',
            description='Enable mission health monitoring'
        ),
        DeclareLaunchArgument(
            'enable_streaming',
            default_value='true',
            description='Enable MJPEG video streaming'
        ),
        DeclareLaunchArgument(
            'enable_dashboard',
            default_value='true',
            description='Enable web dashboard'
        ),
        
        # === BEACON HOMING ===
        DeclareLaunchArgument(
            'enable_beacon_homing',
            default_value='false',
            description='Enable autonomous beacon homing system'
        ),
        DeclareLaunchArgument(
            'beacon_target_uuid',
            default_value='',
            description='Target beacon UUID (empty = any beacon)'
        ),
        DeclareLaunchArgument(
            'beacon_arrival_distance',
            default_value='0.5',
            description='Distance to consider arrived at beacon (meters)'
        ),
        
        # === OPTIONAL MAP FILE ===
        DeclareLaunchArgument(
            'map_file',
            default_value='',
            description='Path to pre-built map file'
        ),
        DeclareLaunchArgument(
            'landmark_map_file',
            default_value='',
            description='Path to landmark map file'
        ),
    ]
    
    # Get launch configurations
    mode = LaunchConfiguration('mode')
    use_mock = LaunchConfiguration('use_mock')
    use_sim_time = LaunchConfiguration('use_sim_time')
    enable_slam = LaunchConfiguration('enable_slam')
    enable_nav2 = LaunchConfiguration('enable_nav2')
    enable_camera = LaunchConfiguration('enable_camera')
    enable_auto_exposure = LaunchConfiguration('enable_auto_exposure')
    enable_landmarks = LaunchConfiguration('enable_landmarks')
    enable_waypoints = LaunchConfiguration('enable_waypoints')
    enable_health_monitor = LaunchConfiguration('enable_health_monitor')
    enable_streaming = LaunchConfiguration('enable_streaming')
    enable_dashboard = LaunchConfiguration('enable_dashboard')
    enable_beacon_homing = LaunchConfiguration('enable_beacon_homing')
    beacon_target_uuid = LaunchConfiguration('beacon_target_uuid')
    beacon_arrival_distance = LaunchConfiguration('beacon_arrival_distance')
    landmark_map_file = LaunchConfiguration('landmark_map_file')
    
    # Conditions
    is_full_mode = LaunchConfigurationEquals('mode', 'full')
    is_beacon_mode = LaunchConfigurationEquals('mode', 'beacon_homing')
    is_minimal_mode = LaunchConfigurationEquals('mode', 'minimal')
    
    # =========================================================================
    # PHASE 1: HARDWARE DRIVERS (Start immediately)
    # =========================================================================
    phase1_hardware = GroupAction([
        LogInfo(msg='\n' + '='*70),
        LogInfo(msg='  PHASE 1: Starting Hardware Drivers'),
        LogInfo(msg='='*70 + '\n'),
        
        # --- VEX Serial Node ---
        Node(
            package='vex_serial',
            executable='vex_serial_node. py',
            name='vex_serial_node',
            output='screen',
            parameters=[vex_config, {'use_sim_time': use_sim_time}],
            condition=UnlessCondition(use_mock)
        ),
        Node(
            package='vex_serial',
            executable='vex_mock_node.py',
            name='vex_serial_node',
            output='screen',
            parameters=[vex_config, {'use_sim_time': use_sim_time}],
            condition=IfCondition(use_mock)
        ),
        
        # --- IMU Node ---
        Node(
            package='imu_driver',
            executable='mpu6050_node.py',
            name='mpu6050_node',
            output='screen',
            parameters=[imu_config, {'use_sim_time': use_sim_time}],
            condition=UnlessCondition(use_mock)
        ),
        Node(
            package='imu_driver',
            executable='imu_mock_node.py',
            name='mpu6050_node',
            output='screen',
            parameters=[imu_config, {'use_sim_time': use_sim_time}],
            condition=IfCondition(use_mock)
        ),
        
        # --- ToF Depth Camera Node (always needed for obstacle avoidance) ---
        Node(
            package='arducam_tof',
            executable='arducam_tof_node.py',
            name='arducam_tof_node',
            output='screen',
            parameters=[tof_config, {'use_sim_time': use_sim_time}],
            condition=UnlessCondition(use_mock)
        ),
        Node(
            package='arducam_tof',
            executable='tof_mock_node.py',
            name='arducam_tof_node',
            output='screen',
            parameters=[tof_config, {'use_sim_time': use_sim_time}],
            condition=IfCondition(use_mock)
        ),
        
        # --- RGB Camera Node (optional for beacon_homing mode) ---
        Node(
            package='imx500_camera',
            executable='imx500_camera_node.py',
            name='imx500_camera_node',
            output='screen',
            parameters=[camera_config, {'use_sim_time': use_sim_time}],
            condition=IfCondition(
                PythonExpression([
                    "'", enable_camera, "' == 'true' and '", use_mock, "' == 'false'"
                ])
            )
        ),
        Node(
            package='imx500_camera',
            executable='camera_mock_node.py',
            name='imx500_camera_node',
            output='screen',
            parameters=[camera_config, {'use_sim_time':  use_sim_time}],
            condition=IfCondition(
                PythonExpression([
                    "'", enable_camera, "' == 'true' and '", use_mock, "' == 'true'"
                ])
            )
        ),
    ])
    
    # =========================================================================
    # PHASE 2: ROBOT DESCRIPTION & TF (Start immediately)
    # =========================================================================
    phase2_description = GroupAction([
        LogInfo(msg='\n' + '='*70),
        LogInfo(msg='  PHASE 2: Starting Robot Description'),
        LogInfo(msg='='*70 + '\n'),
        
        IncludeLaunchDescription(
            PythonLaunchDescriptionSource(
                os.path.join(pkg_description, 'launch', 'description.launch.py')
            ),
            launch_arguments={'use_sim_time': use_sim_time}.items()
        ),
    ])
    
    # =========================================================================
    # PHASE 3: SENSOR FUSION - EKF (Delay 2 seconds)
    # =========================================================================
    phase3_fusion = TimerAction(
        period=2.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n' + '='*70),
                LogInfo(msg='  PHASE 3: Starting EKF Sensor Fusion'),
                LogInfo(msg='='*70 + '\n'),
                
                Node(
                    package='robot_localization',
                    executable='ekf_node',
                    name='ekf_filter_node',
                    output='screen',
                    parameters=[ekf_config, {'use_sim_time': use_sim_time}],
                    remappings=[('/odometry/filtered', '/odom')]
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 4: BLUETOOTH SCANNER (Delay 3 seconds)
    # Always start if beacon_homing enabled or in beacon_homing mode
    # =========================================================================
    phase4_bluetooth = TimerAction(
        period=3.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n>>> Starting Bluetooth Scanner.. .\n'),
                
                Node(
                    package='bluetooth_nav',
                    executable='beacon_scanner_node. py',
                    name='beacon_scanner_node',
                    output='screen',
                    parameters=[bluetooth_config],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_beacon_homing, "' == 'true' or '", mode, "' == 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 5A: BEACON HOMING (Delay 4 seconds) - For beacon_homing mode
    # =========================================================================
    phase5a_beacon_homing = TimerAction(
        period=4.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n' + '='*70),
                LogInfo(msg='  ðŸŽ¯ Starting Beacon Homing System'),
                LogInfo(msg='='*70 + '\n'),
                
                Node(
                    package='beacon_homing',
                    executable='beacon_homing_node.py',
                    name='beacon_homing_node',
                    output='screen',
                    parameters=[
                        beacon_homing_config,
                        {'use_sim_time': use_sim_time},
                        {'target_uuid': beacon_target_uuid},
                        {'arrival_distance': beacon_arrival_distance},
                    ],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_beacon_homing, "' == 'true' or '", mode, "' == 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 5B: SLAM - RTAB-Map (Delay 4 seconds) - For full mode
    # =========================================================================
    phase5b_slam = TimerAction(
        period=4.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n' + '='*70),
                LogInfo(msg='  PHASE 5: Starting RTAB-Map SLAM'),
                LogInfo(msg='='*70 + '\n'),
                
                Node(
                    package='rtabmap_slam',
                    executable='rtabmap',
                    name='rtabmap',
                    output='screen',
                    parameters=[
                        rtabmap_config,
                        {'use_sim_time': use_sim_time}
                    ],
                    remappings=[
                        ('rgb/image', '/camera/image_raw'),
                        ('rgb/camera_info', '/camera/camera_info'),
                        ('depth/image', '/tof/depth/image_raw'),
                        ('odom', '/odom'),
                    ],
                    arguments=['--delete_db_on_start'],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_slam, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 6: PERCEPTION (Delay 5 seconds) - For full mode
    # =========================================================================
    phase6_perception = TimerAction(
        period=5.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n>>> Starting Perception Systems...\n'),
                
                # Auto-Exposure Controller
                Node(
                    package='auto_exposure',
                    executable='auto_exposure_node.py',
                    name='auto_exposure_node',
                    output='screen',
                    parameters=[auto_exp_config, {'use_sim_time':  use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_auto_exposure, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # YOLO Landmark Detector
                Node(
                    package='landmark_system',
                    executable='yolo_detector_node.py',
                    name='yolo_detector_node',
                    output='screen',
                    parameters=[landmark_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_landmarks, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Landmark 3D Localizer
                Node(
                    package='landmark_system',
                    executable='landmark_localizer_node.py',
                    name='landmark_localizer_node',
                    output='screen',
                    parameters=[landmark_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_landmarks, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Landmark Verification
                Node(
                    package='landmark_system',
                    executable='landmark_verification_node.py',
                    name='landmark_verification_node',
                    output='screen',
                    parameters=[
                        landmark_config,
                        {'use_sim_time':  use_sim_time},
                        {'landmark_map_file': landmark_map_file}
                    ],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_landmarks, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 7: NAVIGATION - Nav2 (Delay 6 seconds) - For full mode
    # =========================================================================
    phase7_navigation = TimerAction(
        period=6.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n' + '='*70),
                LogInfo(msg='  PHASE 7: Starting Nav2 Navigation'),
                LogInfo(msg='='*70 + '\n'),
                
                # Controller Server
                Node(
                    package='nav2_controller',
                    executable='controller_server',
                    name='controller_server',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Planner Server
                Node(
                    package='nav2_planner',
                    executable='planner_server',
                    name='planner_server',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Behavior Server
                Node(
                    package='nav2_behaviors',
                    executable='behavior_server',
                    name='behavior_server',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # BT Navigator
                Node(
                    package='nav2_bt_navigator',
                    executable='bt_navigator',
                    name='bt_navigator',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Waypoint Follower (Nav2)
                Node(
                    package='nav2_waypoint_follower',
                    executable='waypoint_follower',
                    name='nav2_waypoint_follower',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time':  use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Velocity Smoother
                Node(
                    package='nav2_velocity_smoother',
                    executable='velocity_smoother',
                    name='velocity_smoother',
                    output='screen',
                    parameters=[nav2_config, {'use_sim_time': use_sim_time}],
                    remappings=[
                        ('cmd_vel', '/cmd_vel_nav'),
                        ('cmd_vel_smoothed', '/vex/cmd_vel')
                    ],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Lifecycle Manager
                Node(
                    package='nav2_lifecycle_manager',
                    executable='lifecycle_manager',
                    name='lifecycle_manager_navigation',
                    output='screen',
                    parameters=[
                        {'use_sim_time': use_sim_time},
                        {'autostart': True},
                        {'node_names': [
                            'controller_server',
                            'planner_server',
                            'behavior_server',
                            'bt_navigator',
                            'nav2_waypoint_follower',
                            'velocity_smoother',
                        ]}
                    ],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_nav2, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 8: MISSION MANAGEMENT (Delay 8 seconds)
    # =========================================================================
    phase8_mission = TimerAction(
        period=8.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n>>> Starting Mission Management...\n'),
                
                # Mission Health Monitor
                Node(
                    package='mission_health',
                    executable='mission_health_node.py',
                    name='mission_health_node',
                    output='screen',
                    parameters=[health_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(enable_health_monitor)
                ),
                
                # Waypoint Recorder (for full mode)
                Node(
                    package='waypoint_manager',
                    executable='waypoint_recorder_node.py',
                    name='waypoint_recorder_node',
                    output='screen',
                    parameters=[waypoint_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_waypoints, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
                
                # Waypoint Follower (our custom node)
                Node(
                    package='waypoint_manager',
                    executable='waypoint_follower_node.py',
                    name='waypoint_follower_node',
                    output='screen',
                    parameters=[waypoint_config, {'use_sim_time': use_sim_time}],
                    condition=IfCondition(
                        PythonExpression([
                            "'", enable_waypoints, "' == 'true' and '", mode, "' != 'beacon_homing'"
                        ])
                    )
                ),
            ])
        ]
    )
    
    # =========================================================================
    # PHASE 9: UTILITIES (Delay 10 seconds)
    # =========================================================================
    phase9_utilities = TimerAction(
        period=10.0,
        actions=[
            GroupAction([
                LogInfo(msg='\n>>> Starting Utilities...\n'),
                
                # MJPEG Streaming
                Node(
                    package='rover_streaming',
                    executable='mjpeg_streaming_node.py',
                    name='mjpeg_streaming_node',
                    output='screen',
                    parameters=[streaming_config],
                    condition=IfCondition(enable_streaming)
                ),
                
                # Web Dashboard
                Node(
                    package='web_dashboard',
                    executable='dashboard_node.py',
                    name='web_dashboard_node',
                    output='screen',
                    condition=IfCondition(enable_dashboard)
                ),
            ])
        ]
    )
    
    # =========================================================================
    # STARTUP COMPLETE MESSAGE
    # =========================================================================
    startup_complete_full = TimerAction(
        period=12.0,
        actions=[
            LogInfo(msg='\n' + '='*70),
            LogInfo(msg='  ðŸš€ LUNAR ROVER FULL SYSTEM READY!  ðŸŒ™'),
            LogInfo(msg='='*70),
            LogInfo(msg='\n  Mode:  FULL (SLAM + Nav2)'),
            LogInfo(msg='\n  Web Dashboard:     http://localhost:5000'),
            LogInfo(msg='  Camera Stream:    http://localhost:8080/stream'),
            LogInfo(msg='\n  Waypoint Commands: '),
            LogInfo(msg='    Start recording: '),
            LogInfo(msg='      ros2 service call /waypoint_recorder/start std_srvs/srv/SetBool "{data: true}"'),
            LogInfo(msg='    Stop recording:'),
            LogInfo(msg='      ros2 service call /waypoint_recorder/stop std_srvs/srv/Trigger'),
            LogInfo(msg='    Follow waypoints:'),
            LogInfo(msg='      ros2 service call /waypoint_follower/start std_srvs/srv/Trigger'),
            LogInfo(msg='\n' + '='*70 + '\n'),
        ],
        condition=IfCondition(
            PythonExpression(["'", mode, "' == 'full'"])
        )
    )
    
    startup_complete_beacon = TimerAction(
        period=6.0,
        actions=[
            LogInfo(msg='\n' + '='*70),
            LogInfo(msg='  ðŸŽ¯ BEACON HOMING SYSTEM READY! ðŸŒ™'),
            LogInfo(msg='='*70),
            LogInfo(msg='\n  Mode:  BEACON HOMING (No SLAM, reactive navigation)'),
            LogInfo(msg='\n  Start homing:'),
            LogInfo(msg='    ros2 service call /beacon_homing/start std_srvs/srv/SetBool "{data: true}"'),
            LogInfo(msg='\n  Stop homing:'),
            LogInfo(msg='    ros2 service call /beacon_homing/start std_srvs/srv/SetBool "{data: false}"'),
            LogInfo(msg='\n  Monitor status:'),
            LogInfo(msg='    ros2 topic echo /beacon_homing/status'),
            LogInfo(msg='\n  Detailed state:'),
            LogInfo(msg='    ros2 topic echo /beacon_homing/state'),
            LogInfo(msg='\n' + '='*70 + '\n'),
        ],
        condition=IfCondition(
            PythonExpression(["'", mode, "' == 'beacon_homing'"])
        )
    )
    
    # =========================================================================
    # RETURN LAUNCH DESCRIPTION
    # =========================================================================
    return LaunchDescription(
        declared_arguments + [
            # Phase 1 & 2: Start immediately
            phase1_hardware,
            phase2_description,
            
            # Phase 3: EKF (2 second delay)
            phase3_fusion,
            
            # Phase 4: Bluetooth Scanner (3 second delay)
            phase4_bluetooth,
            
            # Phase 5A:  Beacon Homing (4 second delay)
            phase5a_beacon_homing,
            
            # Phase 5B: SLAM (4 second delay) - for full mode
            phase5b_slam,
            
            # Phase 6: Perception (5 second delay) - for full mode
            phase6_perception,
            
            # Phase 7: Navigation (6 second delay) - for full mode
            phase7_navigation,
            
            # Phase 8: Mission Management (8 second delay)
            phase8_mission,
            
            # Phase 9: Utilities (10 second delay)
            phase9_utilities,
            
            # Startup complete messages
            startup_complete_full,
            startup_complete_beacon,
        ]
    )