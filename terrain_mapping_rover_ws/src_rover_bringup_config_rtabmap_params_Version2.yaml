# =============================================================================
# RTAB-Map Configuration for Lunar Rover
# =============================================================================
#
# This configuration is optimized for: 
# - Low-texture lunar/indoor terrain
# - RGB-D camera (IMX500 RGB + Arducam ToF depth)
# - Small robot with limited compute (Raspberry Pi 5)
#
# Sensor setup:
# - RGB:  /camera/image_raw (1280x720 @ 30Hz)
# - Depth: /tof/depth/image_raw (240x180 @ 15Hz)
# - Odometry: /odom (EKF fused wheel + IMU)
#
# =============================================================================

# =============================================================================
# RTAB-MAP SLAM NODE
# =============================================================================
rtabmap:
  ros__parameters:
    # =========== FRAME CONFIGURATION ===========
    frame_id: "base_link"           # Robot base frame
    odom_frame_id: "odom"           # Odometry frame
    map_frame_id: "map"             # Map frame (published by RTAB-Map)
    
    # =========== INPUT CONFIGURATION ===========
    subscribe_depth: true           # Subscribe to depth images
    subscribe_rgb: true             # Subscribe to RGB images
    subscribe_odom_info: false      # Don't need odom info from external source
    subscribe_scan: false           # No 2D lidar
    subscribe_scan_cloud: false     # No 3D lidar
    
    # =========== SYNCHRONIZATION ===========
    approx_sync: true               # Use approximate time sync (required for different rate sensors)
    approx_sync_max_interval: 0.1   # Max time diff between RGB and depth (100ms)
    queue_size: 10                  # Message queue size
    
    # =========== TRANSFORM CONFIGURATION ===========
    publish_tf: true                # Publish map -> odom transform
    wait_for_transform: 0.2         # Wait time for TF lookups (seconds)
    tf_delay: 0.05                  # TF publication delay
    tf_tolerance: 0.1               # TF time tolerance
    
    # =========== DATABASE ===========
    database_path: "~/.ros/rtabmap. db"  # Database file location
    
    # =========== DETECTION RATE ===========
    # How often to process frames for loop closure (Hz)
    # Lower = less CPU, but may miss loop closures
    Rtabmap/DetectionRate: 1.0
    
    # =========== MEMORY MANAGEMENT ===========
    # These control how much history to keep
    Mem/IncrementalMemory: "true"   # Keep adding to map
    Mem/InitWMWithAllNodes: "false" # Don't load all nodes to working memory on start
    Mem/STMSize: 10                 # Short-term memory size
    Mem/RehearsalSimilarity: 0.3    # Similarity threshold for rehearsal
    
    # =========== FEATURE DETECTION ===========
    # For low-texture environments, use more features
    Kp/MaxFeatures: 500             # Max features to extract per image
    Kp/DetectorStrategy: 8          # 0=SURF, 1=SIFT, 2=ORB, 6=GFTT, 8=GFTT/BRIEF
    Kp/NNStrategy: 1                # 1=KNN (more robust)
    Kp/NndrRatio: 0.8               # Nearest neighbor distance ratio
    Kp/MaxDepth: 3. 0                # Max depth for feature matching (meters)
    Kp/MinDepth: 0.1                # Min depth for feature matching (meters)
    
    # =========== VISUAL ODOMETRY ===========
    Odom/Strategy: 0                # 0=Frame-to-Map, 1=Frame-to-Frame
    Odom/GuessMotion: "true"        # Use motion model for initial guess
    Odom/ResetCountdown: 1          # Frames before resetting if lost
    
    # =========== VISUAL MATCHING ===========
    Vis/MinInliers: 15              # Min inliers to accept transformation
    Vis/InlierDistance: 0.1         # Max distance for inlier (meters)
    Vis/MaxFeatures: 500            # Max features for visual matching
    Vis/FeatureType: 8              # Same as Kp/DetectorStrategy
    
    # =========== LOOP CLOSURE ===========
    RGBD/NeighborLinkRefining: "true"   # Refine neighbor links
    RGBD/ProximityBySpace: "true"       # Detect loop closures by proximity
    RGBD/ProximityByTime: "false"       # Don't use time-based proximity
    RGBD/ProximityPathMaxNeighbors: 10  # Max neighbors for proximity detection
    RGBD/AngularUpdate: 0.1             # Min angular change to create node (rad)
    RGBD/LinearUpdate: 0.1              # Min linear change to create node (m)
    RGBD/OptimizeFromGraphEnd: "false"  # Optimize from graph start
    RGBD/MaxLocalRetrieved: 2           # Max local nodes to retrieve
    
    # =========== OPTIMIZATION ===========
    Optimizer/Strategy: 2           # 0=TORO, 1=g2o, 2=GTSAM
    Optimizer/Iterations: 20        # Optimization iterations
    Optimizer/Slam2D:  "true"        # 2D SLAM (robot on ground)
    Optimizer/VarianceIgnored: "false"
    
    # =========== GRID MAP ===========
    Grid/FromDepth: "true"          # Build occupancy grid from depth
    Grid/MaxGroundHeight: 0.05      # Max height for ground (meters)
    Grid/MaxObstacleHeight: 0.5     # Max height for obstacles (meters)
    Grid/MinClusterSize: 10         # Min points for obstacle cluster
    Grid/CellSize: 0.05             # Grid cell size (meters)
    Grid/RangeMax: 3.0              # Max range for grid (meters)
    Grid/RangeMin: 0.1              # Min range for grid (meters)
    Grid/RayTracing: "true"         # Use ray tracing for free space
    Grid/3D: "false"                # 2D grid only
    Grid/NormalsSegmentation: "true" # Use normal estimation
    
    # =========== MAP PUBLISHING ===========
    # Publish the 2D occupancy grid map
    grid_map:  true
    map_filter_radius: 0.1
    map_filter_angle: 30.0
    map_cleanup: true
    map_always_update: false
    map_empty_ray_tracing: true
    cloud_output_voxelized: true
    cloud_voxel_size: 0.05


# =============================================================================
# RTAB-MAP ODOMETRY NODE (Optional - can use EKF instead)
# =============================================================================
rgbd_odometry:
  ros__parameters:
    frame_id: "base_link"
    odom_frame_id: "odom"
    publish_tf: false               # Don't publish TF - EKF does this
    publish_null_when_lost: true
    wait_for_transform: 0.2
    approx_sync: true
    approx_sync_max_interval:  0.1
    queue_size: 10
    
    # Visual odometry parameters
    Odom/Strategy: 0                # Frame-to-Map
    Odom/ResetCountdown: 1
    Odom/Holonomic: "false"         # Non-holonomic (differential drive)
    Odom/GuessMotion: "true"
    
    # Feature detection
    Vis/FeatureType: 8              # GFTT/BRIEF
    Vis/MaxFeatures: 500
    Vis/MinInliers: 15
    Vis/InlierDistance: 0.1
    
    # Depth
    Vis/MaxDepth: 3.0
    Vis/MinDepth: 0.1


# =============================================================================
# RTAB-MAP VISUALIZATION NODE
# =============================================================================
rtabmap_viz:
  ros__parameters:
    frame_id:  "base_link"
    odom_frame_id: "odom"
    subscribe_depth: true
    subscribe_rgb: true
    subscribe_odom_info: true
    approx_sync: true
    queue_size: 10